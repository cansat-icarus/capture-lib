<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/icarus/backend/index.js | CanSat Groundstation Library API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/cansat-icarus/capture-lib.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/parser.js~Parser.html">Parser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/serial.js~Serial.html">Serial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-listPorts">listPorts</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">icarus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/station.js~Station.html">Station</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tMinusPid">tMinusPid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tMinusVid">tMinusVid</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">icarus/backend</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/backend/index.js~Backend.html">Backend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/backend/replicator.js~Replicator.html">Replicator</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">icarus/classifier</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/classifier/index.js~Classifier.html">Classifier</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-minmaxH">minmaxH</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-variationH">variationH</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">icarus/data-handler</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/data-handler/parser.js~IcarusParser.html">IcarusParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dataHandler">dataHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parser">parser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-DS18B20">DS18B20</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-LIS331HH_24G">LIS331HH_24G</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-MMA7361_6G">MMA7361_6G</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-MPX4115A">MPX4115A</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-analogToMV">analogToMV</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBit">getBit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsAltitude">gpsAltitude</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsCoordinate">gpsCoordinate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsCourse">gpsCourse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsFlags">gpsFlags</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsSpeed">gpsSpeed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-messages">messages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-moduleNames">moduleNames</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tmBuffer">tmBuffer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/backoff-wrapper.js~ExponentialBackoff.html">ExponentialBackoff</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDB">getDB</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getRemoteDB">getRemoteDB</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createLogger">createLogger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-passEvent">passEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-normalizePath">normalizePath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pathPrefix">pathPrefix</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/icarus/backend/index.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {EventEmitter} from &apos;events&apos;
import {stringify as qsStringify} from &apos;querystring&apos;
import io from &apos;socket.io-client&apos;
import {version} from &apos;../../../package.json&apos;
import passEvent from &apos;../../lib/pass-event&apos;
import Replicator from &apos;./replicator&apos;

/**
 * Handles connection with the backend.
 *
 * Responsible for establishing a WebSocket (socket.io) connection with
 * the backend and handling its requests.
 *
 * It also instantiates {@link Replicator} instances for data and log
 * replication. The stateChange events from these are forwarded as:
 * &quot;replicator:data:state&quot; and &quot;replicator:log:state&quot;.
 */
export default class Backend extends EventEmitter {
	/**
	 * Constructor.
	 * @param {String} name Station name.
	 * @param {Bunyan} logger Logger instance.
	 * @param {PouchDB} dataDB Packet database.
	 * @param {PouchDB} logDB Log entries database.
	 */
	constructor(name, logger, dataDB, logDB) {
		super()

		/**
		 * Station name.
		 * @type {String}
		 */
		this.name = name

		/**
		 * Current socket connection with the backend.
		 * @type {!IO}
		 */
		this._socket = undefined

		/**
		 * Current socket state.
		 * @type {String}
		 */
		this._state = &apos;inactive&apos;

		/**
		 * Logger instance.
		 * @type {Bunyan}
		 */
		this._log = logger

		/**
		 * {@link Replicator} instance for dataDB.
		 * @type {Replicator}
		 */
		this.dataReplicator = new Replicator(
			this._log.child({childId: &apos;backend.replicator:data&apos;}),
			dataDB
		)

		passEvent(this.dataReplicator, this, &apos;state&apos;, &apos;replicator:data:state&apos;)

		/**
		 * {@link Replicator} instance for logDB.
		 * @type {Replicator}
		 */
		this.logReplicator = new Replicator(
			this._log.child({childId: &apos;backend.replicator:log&apos;}),
			logDB
		)

		passEvent(this.logReplicator, this, &apos;state&apos;, &apos;replicator:log:state&apos;)

		this._log.info(&apos;backend.construct&apos;)
	}

	/**
	 * Connects to backend at [url].
	 * @param {String} url Backend URL.
	 * @emits state(socketState): socket connection/disconnection.
	 */
	connect(url) {
		this._log.info(&apos;connect to&apos;, url)

		this._socket = io(url, {
			query: qsStringify({
				name: this.name
				// TODO: include auth info
			})
		})

		// Return env information
		this._socket.on(&apos;info&apos;, cb =&gt; cb({version, name: this.name}))

		// Keep track of state
		this._socket.on(&apos;reconnecting&apos;, attempt =&gt; this._updateState((this._state === &apos;inactive&apos; ? &apos;connecting&apos; : &apos;reconnecting&apos;), {attempt}))
		this._socket.on(&apos;reconnect_error&apos;, () =&gt; this._updateState(this._state === &apos;connecting&apos; ? &apos;connect_error&apos; : &apos;reconnect_error&apos;))
		this._socket.on(&apos;connect&apos;, () =&gt; this._updateState(&apos;connect&apos;))
		this._socket.on(&apos;disconnected&apos;, () =&gt; this._updateState(&apos;disconnect&apos;))

		// Respond to replication requests
		this._socket.on(&apos;replicate&apos;, (dataDbUrl, logDbUrl, user, pass) =&gt; {
			this.dataReplicator.replicate(dataDbUrl, user, pass)
			this.logReplicator.replicate(logDbUrl, user, pass)
		})
	}

	/**
	 * Disconnects from the backend. Stops the socket.
	 * The replicators will keep running until a new connection makes them
	 * connect to a different database.
	 * @emits state(socketState): socket connection/disconnection.
	 */
	disconnect() {
		this._log.info(&apos;backend.disconnect&apos;)

		// TODO: warn disconnection through socket (soft disconnection)

		// Disconnect socket to stop reconnection logic
		this._socket.disconnect()

		// Finally remove the socket reference here
		this._socket = null

		// Stop the replicators
		// The operator may be experiencing issues and prefer to keep them off
		this.dataReplicator.stop()
		this.logReplicator.stop()

		this._updateState(&apos;inactive&apos;)
	}

	/**
	 * Triggers {@link Replicator#cleanup} on the data and log replicators.
	 * @emits state(&apos;cleanup&apos;)
	 * @returns {Promise}
	 */
	async cleanup() {
		this._log.info(&apos;backend.cleanup&apos;)
		this._updateState(&apos;cleanup&apos;)

		// Cleanup replicators
		await Promise.all([
			this.dataReplicator.cleanup(),
			this.logReplicator.cleanup()
		])

		// TODO: soft-disconnect (maybe?)
	}

	/**
	 * Updates the socket state.
	 * @protected
	 * @param {String} state New Backend state.
	 * @param {Object} [extraData] Extra data related to the new state (error, no. of connection attempts...) to be included in logs.
	 * @emits state(socketState): socket connection/disconnection.
	 */
	_updateState(state, extraData) {
		this._log.info(&apos;updateState&apos;, state, extraData)
		this._state = state
		this.emit(&apos;state&apos;, state)
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
