<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/parser.js | CanSat Groundstation Library API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/cansat-icarus/capture-lib.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/parser.js~Parser.html">Parser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/serial.js~Serial.html">Serial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-listPorts">listPorts</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">icarus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/station.js~Station.html">Station</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tMinusPid">tMinusPid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tMinusVid">tMinusVid</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">icarus/backend</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/backend/index.js~Backend.html">Backend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/backend/replicator.js~Replicator.html">Replicator</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">icarus/classifier</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/classifier/index.js~Classifier.html">Classifier</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-minmaxH">minmaxH</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-variationH">variationH</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">icarus/data-handler</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/data-handler/parser.js~IcarusParser.html">IcarusParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dataHandler">dataHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parser">parser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-DS18B20">DS18B20</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-LIS331HH_24G">LIS331HH_24G</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-MMA7361_6G">MMA7361_6G</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-MPX4115A">MPX4115A</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-analogToMV">analogToMV</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBit">getBit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsAltitude">gpsAltitude</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsCoordinate">gpsCoordinate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsCourse">gpsCourse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsFlags">gpsFlags</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsSpeed">gpsSpeed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-messages">messages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-moduleNames">moduleNames</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tmBuffer">tmBuffer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/backoff-wrapper.js~ExponentialBackoff.html">ExponentialBackoff</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDB">getDB</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getRemoteDB">getRemoteDB</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createLogger">createLogger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-passEvent">passEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-normalizePath">normalizePath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pathPrefix">pathPrefix</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/parser.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {crc32} from &apos;crc&apos;
import {set as objPathSet} from &apos;object-path&apos;

/**
 * Parser creation helper class. Any subclasses should reimplement the parse method,
 * calling super.parse in the beginning. You have useful methods for reading regular C
 * datatypes from the buffer: readInt, readFloat, readChar... To use it in node-serialport
 * or the serial wrapper just pass in ::Parser.parse
 * Keep in mind not initialize this class as is. RE-IMPLEMENT Parser.parse!
 */
export default class Parser {
	/**
	 * @param {String} [endianess=&apos;LE&apos;] Set byte-order to big endian (BE) or little endian (LE).
	 */
	constructor(endianess = &apos;LE&apos;) {
		/**
		 * Current packet being parsed.
		 * @type {!Object}
		 * @protected
		 */
		this._raw = undefined

		/**
		 * Current position in the packet being parsed.
		 * @type {Number}
		 * @protected
		 */
		this._i = 0

		/**
		 * Parsed output container.
		 * @type {Object}
		 * @property {String} crc.sent The CRC32 checkum sent along with the packet.
		 * @property {String} crc.local The CRC32 checksum calculated from the sent data.
		 */
		this.packet = Object.create(null)

		/**
		 * Raw packet byte endianess (Little Endian (LE) for the Arduino).
		 * Acceptable values: LE, BE.
		 * @type {String}
		 */
		this.endianess = endianess
	}

	/**
	 * Parses a packet. Default implementation resets state and calculates and extracts the CRC32
	 * checksum before parsing the new packet.
	 * That&apos;s why, if you want any parsing at all to be performed, YOU MUST RE-IMPLEMENT THIS METHOD.
	 * Preferrably calling this implementation before any parsing(but after any decoding
	 * *wink* *wink* quasi-binary decoder).
	 * @param {Buffer} rawPacket The packet to be parsed.
	 * @return {Object} The parsed object.
	 */
	parse(rawPacket) {
		// Change the current packet
		this._raw = rawPacket

		// Reset state thingies
		this._i = 0
		this.packet = Object.create(null)

		// Calculate CRC
		if (this._raw.length &gt; 4) {
			this.setValue(&apos;crc.sent&apos;, rawPacket[`readUInt${this.endianess}`](rawPacket.length - 4, 4).toString(16))
			this.setValue(&apos;crc.local&apos;, crc32(rawPacket.slice(0, rawPacket.length - 4)).toString(16))
		}

		// More parsing reserved to subclass
		return this.packet // Just to behave as the Docs say it will
	}

	/**
	 * The value setter called by read* helper functions.
	 * Uses object path dot notation in the key and can convert values in one line.
	 * @param {String} key The object path where the value will be inserted.
	 * @param {mixed} val Anything you want to put.
	 * @param {Function} [converter=identity] A function that converts the value.
	 * @return {mixed} The provided value (val).
	 */
	setValue(key, val, converter = v =&gt; v) {
		// Set the value in this.packet.[key]
		objPathSet(this.packet, key, converter(val))
		return val
	}

	/**
	 * Reads a signed integer of 1-6 bytes.
	 * @param {String} key The dot notation path where the int goes to.
	 * @param {Number} [size=1] The size in bytes of the integer (1 to 6 bytes only).
	 * @param {Function} [converter=identity] A function that converts the value.
	 * @return {Number} The read integer.
	 */
	readInt(key, size = 1, converter) {
		// Get the value and update the index
		const val = this._raw[`readInt${this.endianess}`](this._i, size)
		this._i += size

		return this.setValue(key, val, converter)
	}

	/**
	 * Reads an unsigned integer of 1-6 bytes.
	 * @param {String} key The dot notation path where the int goes to.
	 * @param {Number} [size=1] The size in bytes of the integer (1 to 6 bytes only).
	 * @param {Function} [converter=identity] A function that converts the value.
	 * @return {Number} The read integer.
	 */
	readUInt(key, size = 1, converter) {
		// Get the value and update the index
		const val = this._raw[`readUInt${this.endianess}`](this._i, size)
		this._i += size

		return this.setValue(key, val, converter)
	}

	/**
	 * Reads a 32-bit float.
	 * @param {String} key The dot notation path where the float goes to.
	 * @param {Function} [converter=identity] A function that converts the value.
	 * @return {Number} The read float.
	 */
	readFloat(key, converter) {
		// Get the value and update the index
		const val = this._raw[`readFloat${this.endianess}`](this._i)
		this._i += 4

		return this.setValue(key, val, converter)
	}

	/**
	 * Reads a char.
	 * @param {String} key The dot notation path where the char goes to.
	 * @param {Function} [converter=identity] A function that converts the value.
	 * @return {String} The read char.
	 */
	readChar(key, converter) {
		return this.setValue(key, String.fromCharCode(this._raw[this._i++]), converter)
	}

	/**
	 * Reads a boolean.
	 * @param {String} key The dot notation path where the boolean goes to.
	 * @param {Function} [converter=identity] A function that converts the value.
	 * @return {Boolean} The read boolean.
	 */
	readBoolean(key, converter) {
		return this.setValue(key, Boolean(this._raw[this._i++]), converter)
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
