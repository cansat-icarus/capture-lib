<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/serial.js | CanSat Groundstation Library API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/cansat-icarus/capture-lib.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/parser.js~Parser.html">Parser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/serial.js~Serial.html">Serial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-listPorts">listPorts</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">icarus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/station.js~Station.html">Station</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tMinusPid">tMinusPid</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tMinusVid">tMinusVid</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">icarus/backend</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/backend/index.js~Backend.html">Backend</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/backend/replicator.js~Replicator.html">Replicator</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">icarus/classifier</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/classifier/index.js~Classifier.html">Classifier</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-minmaxH">minmaxH</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-variationH">variationH</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">icarus/data-handler</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/icarus/data-handler/parser.js~IcarusParser.html">IcarusParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dataHandler">dataHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parser">parser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-DS18B20">DS18B20</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-LIS331HH_24G">LIS331HH_24G</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-MMA7361_6G">MMA7361_6G</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-MPX4115A">MPX4115A</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-analogToMV">analogToMV</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBit">getBit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsAltitude">gpsAltitude</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsCoordinate">gpsCoordinate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsCourse">gpsCourse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsFlags">gpsFlags</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gpsSpeed">gpsSpeed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-messages">messages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-moduleNames">moduleNames</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tmBuffer">tmBuffer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/backoff-wrapper.js~ExponentialBackoff.html">ExponentialBackoff</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDB">getDB</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getRemoteDB">getRemoteDB</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createLogger">createLogger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-passEvent">passEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-normalizePath">normalizePath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pathPrefix">pathPrefix</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/serial.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {EventEmitter} from &apos;events&apos;
import SerialPort from &apos;serialport&apos;

/**
 * A node-serialport wrapper that keeps track of port state and allows from on-the-fly
 * port path/name changes (automatically attaches/detaches event listeners and keeps config).
 */
export default class Serial extends EventEmitter {
	/**
	 * Constructor: the place for setting the baud rate and parser.
	 * @param {Function} [parser=raw] A node-serialport parser.
	 * @param {Number} [baud=19200] Desired baud rate.
	 */
	constructor(logger, parser, baud = 19200) {
		super()

		/**
		 * Holds the current node-serialport instance.
		 * @type {!SerialPort}
		 */
		this._port = undefined

		/**
		 * Holds the desired serial baud rate.
		 * @type {Number}
		 */
		this._baud = baud

		/**
		 * Holds the parsing function.
		 * @type {!Function}
		 */
		this._parser = parser

		/**
		 * Holds the current port path.
		 * @type {!String}
		 */
		this._path = undefined

		/**
		 * Holds current state. Possible values: disconnect, open, close, disconnect_force.
		 * @type {String}
		 */
		this._state = &apos;close&apos;

		/**
		 * Logger instance. (Bunyan API).
		 * @type Object
		 */
		this._log = logger
	}

	/**
	 * Sets a new path to all future serialport instances. If a port is already open,
	 * it is automatically closed and a new one is opened with the new path (keeps event listeners).
	 * @emits data(packet): New data arrived (after being parsed by Serial#_parser).
	 * @emits stateChange(state): Serial#_state has changed.
	 * @emits error(error): An error ocurred in node-serialport.
	 * @return {Promise} When path is changed and the port recreated/reopened.
	 */
	setPath(path) {
		this._log.debug(&apos;serial.setPath&apos;)
		// Guard for already changed port...
		if (path === this._path) {
			this._log.trace(&apos;serial._path needs no change&apos;, path)
			return Promise.resolve()
		}

		return (new Promise(resolve =&gt; {
			// Any _port recreation will open this new path
			this._log.trace(&apos;serial._path changed to&apos;, path)
			this._path = path

			// Destroy and recreate _port when necessary
			if (this._port) {
				this._log.trace(&apos;serial._path changed: recreating existing port&apos;)
				const open = this._port.isOpen()
				this._destroyPort()
					.then(() =&gt; open ? this.open() : this._createPort())
					.then(resolve)
			} else {
				resolve()
			}
		}))
			.then(() =&gt; this.emit(&apos;pathChange&apos;, path))
	}

	/**
	 * Opens the serialport, creating it if needed.
	 * @emits data(packet): New data arrived (after being parsed by Serial#_parser).
	 * @emits stateChange(state): Serial#_state has changed.
	 * @emits error(error): An error ocurred in node-serialport.
	 * @return {Promise} Resolved when the serial port is open.
	 */
	open() {
		this._log.debug(&apos;serial.open&apos;)
		return new Promise(resolve =&gt; {
			// No port? Create it!
			if (!this._port) {
				this._log.trace(&apos;port does not exist&apos;)
				return this._createPort()
					.then(() =&gt; this.open())
					.then(resolve)
			}

			// Already open = nothing to do
			if (this._port.isOpen()) {
				this._log.trace(&apos;port already open&apos;)
				return resolve()
			}

			// Open the port
			this._log.trace(&apos;calling serial._port.open&apos;)
			this._port.open(resolve)
		})
	}

	/**
	 * Closes the serialport.
	 * @emits stateChange(state): Serial#_state} has changed.
	 * @emits error(error): An error ocurred in node-serialport.
	 * @return {Promise} Resolved when the serialport is closed.
	 */
	close() {
		this._log.debug(&apos;serial.close&apos;)
		// Already closed/no port = nothing to do
		if (!this._port || !this._port.isOpen()) {
			this._log.trace(&apos;port already closed/does not exist&apos;)
			return Promise.resolve()
		}

		this._log.trace(&apos;calling serial._port.close&apos;)
		return new Promise(resolve =&gt; this._port.close(resolve))
	}

	/**
	 * Destroys the current serialport instance. Removing all listeners and closing it beforehand.
	 * @protected
	 * @emits stateChange(state): Serial#_state has changed.
	 * @returns {Promise} Resolves when all is done.
	 */
	_destroyPort() {
		this._log.debug(&apos;serial._destroyPort&apos;)
		if (!this._port) {
			return Promise.resolve()
		}

		return new Promise(resolve =&gt; {
			this._port.removeAllListeners()

			// Only close if necessary
			if (!this._port.isOpen()) {
				this._log.trace(&apos;port not open, removing it&apos;)
				this._port = undefined
				return resolve()
			}

			this._log.trace(&apos;port open, closing&apos;)
			this._port.close(error =&gt; {
				if (error) {
					this._log.error(&apos;Error closing port!&apos;, error)
				}

				// Must keep going
				this._port = undefined
				resolve()
			})
		})
	}

	/**
	 * Creates the serialport instance and attaches all relevant event listeners
	 * that forward data and errors and keep track of state.
	 * @protected
	 * @emits data(packet): New data arrived (after being parsed by Serial#_parser).
	 * @emits stateChange(state): Serial#_state has changed.
	 * @emits error(error): An error ocurred in node-serialport.
	 * @return {Promise} A resolved Promise for easy chaining in {@link Serial#setPath}.
	 */
	_createPort() {
		// Only create if it does not exist
		if (this._port) {
			return Promise.resolve()
		}

		// Create serialport instance
		this._port = new SerialPort(this._path, {
			baudRate: this._baud,
			parser: this._parser,
			autoOpen: false
		})

		// Register event listeners
		this._port.on(&apos;data&apos;, data =&gt; this.emit(&apos;data&apos;, data))
		this._port.on(&apos;error&apos;, error =&gt; {
			this._log.fatal(error)
			this.emit(&apos;error&apos;, error)
		})

		// State tracking
		this._port.on(&apos;open&apos;, () =&gt; this._updateState(&apos;open&apos;))
		this._port.on(&apos;disconnect&apos;, () =&gt; this._updateState(&apos;disconnect_force&apos;))
		this._port.on(&apos;close&apos;, () =&gt; {
			// Detect safe disconnections
			if (this._state === &apos;disconnect_force&apos;) {
				return this._updateState(&apos;disconnect&apos;)
			}
			this._updateState(&apos;close&apos;)
		})

		return Promise.resolve()
	}

	/**
	 * Shortcut for updating state that changes this._state and emits
	 * a stateChange event with one call.
	 * @protected
	 * @param {String} state New state.
	 * @emits stateChange(state): Serial#_state has changed.
	 */
	_updateState(state) {
		this._state = state
		this.emit(&apos;stateChange&apos;, state)
	}
}

/**
 * Lists available ports in the system with SerialPort.list.
 * Tries to fill out vendorId and productId fields in Windows from pnpId.
 * @return {Promise&lt;Array&gt;} Array of port information objects.
 */
export function listPorts() {
	return new Promise(resolve =&gt; {
		SerialPort.list((err, ports) =&gt; {
			if (err) {
				// TODO: reject promise with error, deal with it in Station#getAvailablePorts
				return resolve([])
			}

			// Fill out some missing fields if possible
			ports = ports.map(port =&gt; {
				if ((!port.vendorId || !port.productId) &amp;&amp; port.pnpId) {
					port.vendorId = &apos;0x&apos; + /VID_([0-9,A-Z]*)&amp;/.exec(port.pnpId)[1].toLowerCase()
					port.productId = &apos;0x&apos; + /PID_([0-9,A-Z]*)&amp;/.exec(port.pnpId)[1].toLowerCase()
				}

				return port
			})

			resolve(ports)
		})
	})
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
